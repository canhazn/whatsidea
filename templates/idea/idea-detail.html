{% extends 'idea/idea-base.html' %}
{%load static %}
{% load crispy_forms_tags %}
{% load js %}


<!-- Extra head here -->
{% block extrahead %}
<title>whatsIdea</title>
<meta name="content" content="">
{% endblock extrahead %}



<!-- Content here -->
{% block main-content %}
<style>

</style>
<main>
    <nav class="navbar px-0 border-bottom mb-3">
        <h1 class="h3">{{ idea.title }}</h1>
        <div class="dropdown">
            <button type="button" class="btn" data-toggle="dropdown">
                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-three-dots-vertical" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z">
                    </path>
                </svg>
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                {% if user in idea.founder.all  %}
                <a class="dropdown-item" href="{% url 'idea-update-page' idea.slug %}">Edit</a>
                <a class="dropdown-item" href="{% url 'idea-delete-page' idea.slug %}">Delete</a>
                {% else %}
                <a class="dropdown-item cursor-not-allowed" href="">Report</a>
                {% endif %}
                <a class="dropdown-item cursor-pointer">Share</a>
            </div>
        </div>
    </nav>
    {% if idea.shortdesc %}
    <div class="p-3 border-left-success">
        <p>{{ idea.shortdesc }}</p>
    </div>
    {% endif %}
    <div class="p-3 my-3 border border-left-secondary">
        <div id="editorjs"></div>
    </div>

    <!-- facebook share -->
    <div class="fb-share-area">
        <div class="fb-like" data-href="{{ request.build_absolute_uri }}" data-width="" data-layout="button_count"
            data-action="like" data-size="large" data-share="true"></div>
    </div>

    <!-- vote count -->
    <section class="contribution-area">
        <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="vote">
                <div class="d-inline-block mr-3">
                    <a class="navbar-brand mr-1 cursor-pointer btn-idea-vote" data-idea_id="{{ idea.id }}">
                        {% include "component/vote-icon.html"%}
                    </a>
                    <span>{{ idea.vote_set.all.count }} votes</span>
                </div>
                <div class="d-inline-block">
                    <a class="navbar-brand mr-0" href="">
                        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-puzzle-fill" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd"
                                d="M3.112 3.645A1.5 1.5 0 0 1 4.605 2H7a.5.5 0 0 1 .5.5v.382c0 .696-.497 1.182-.872 1.469a.459.459 0 0 0-.115.118.113.113 0 0 0-.012.025L6.5 4.5v.003l.003.01c.004.01.014.028.036.053a.86.86 0 0 0 .27.194C7.09 4.9 7.51 5 8 5c.492 0 .912-.1 1.19-.24a.86.86 0 0 0 .271-.194.213.213 0 0 0 .036-.054l.003-.01v-.008a.112.112 0 0 0-.012-.025.459.459 0 0 0-.115-.118c-.375-.287-.872-.773-.872-1.469V2.5A.5.5 0 0 1 9 2h2.395a1.5 1.5 0 0 1 1.493 1.645L12.645 6.5h.237c.195 0 .42-.147.675-.48.21-.274.528-.52.943-.52.568 0 .947.447 1.154.862C15.877 6.807 16 7.387 16 8s-.123 1.193-.346 1.638c-.207.415-.586.862-1.154.862-.415 0-.733-.246-.943-.52-.255-.333-.48-.48-.675-.48h-.237l.243 2.855A1.5 1.5 0 0 1 11.395 14H9a.5.5 0 0 1-.5-.5v-.382c0-.696.497-1.182.872-1.469a.459.459 0 0 0 .115-.118.113.113 0 0 0 .012-.025L9.5 11.5v-.003l-.003-.01a.214.214 0 0 0-.036-.053.859.859 0 0 0-.27-.194C8.91 11.1 8.49 11 8 11c-.491 0-.912.1-1.19.24a.859.859 0 0 0-.271.194.214.214 0 0 0-.036.054l-.003.01v.002l.001.006a.113.113 0 0 0 .012.025c.016.027.05.068.115.118.375.287.872.773.872 1.469v.382a.5.5 0 0 1-.5.5H4.605a1.5 1.5 0 0 1-1.493-1.645L3.356 9.5h-.238c-.195 0-.42.147-.675.48-.21.274-.528.52-.943.52-.568 0-.947-.447-1.154-.862C.123 9.193 0 8.613 0 8s.123-1.193.346-1.638C.553 5.947.932 5.5 1.5 5.5c.415 0 .733.246.943.52.255.333.48.48.675.48h.238l-.244-2.855z" />
                        </svg>
                    </a>
                    <span>{{ idea.contribution_set.all.count }} contributions</span>
                </div>
            </div>
            <a class="idea-slug" href="{% url 'idea-detail-page' idea.slug %}">
                @{{ idea.slug }}
            </a>
        </div>

        <!-- contribution area -->
        <div class="contribution-area">
            {% for contribution in contributions %}
            <div>
                <div class="contributions mt-3 px-2 border-left-info">
                    <div class="contribution-content">
                        <p class="m-0"> {{ contribution }} </p>
                    </div>
                    <div class="p-0">
                        <div class="mr-3">
                            <a href="{% url 'user-detail-page' contribution.user %}">@{{ contribution.user }}</a>
                            <span>{{ contribution.date_created | date:"d/m/y H:i"}}</span>
                        </div>
                        <div class="navbar p-0 justify-content-start">
                            <a class="navbar-brand mr-1 cursor-pointer btn-contribution-vote"
                                data-contribution_id="{{ contribution.id }}">
                                {% include "component/vote-icon.html" %}
                            </a>
                            <span class="mr-3">{{ contribution.vote_set.all.count }}</span>
                            <span class="mr-3 btn-reply" data-toggle="collapse"
                                data-target="#sub-contribution-form-{{ contribution.id }}"
                                data-contribution_id="{{ contribution.id }}">{% include "component/reply-icon.html" %}</span>
                            <div class="dropup">
                                <span class="mr-3" data-toggle="dropdown">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-three-dots-vertical"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z">
                                        </path>
                                    </svg></span>
                                <div class="dropdown-menu dropdown-menu-right">

                                    {% if user == contribution.user  %}
                                    <a class="dropdown-item cursor-pointer" data-toggle="modal"
                                        data-target="#confirm-delelte-contribution-{{contribution.id}}">Delete</a>
                                    {% else %}
                                    <a class="dropdown-item cursor-not-allowed">Report</a>
                                    {% endif %}
                                </div>
                            </div>
                            {% if user == contribution.user  %}
                            <!-- confirm delete contribution -->
                            <div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"
                                id="confirm-delelte-contribution-{{contribution.id}}">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title">Are you sure to delete this?</h4>
                                            <button type="button" class="close" data-dismiss="modal"
                                                aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default btn-contribution-delete"
                                                data-contribution_id="{{ contribution.id }}">Yes</button>
                                            <button type="button" class="btn btn-primary"
                                                data-dismiss="modal">No</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% for sub in contribution.children.all %}
                <div class="subs mt-3 ml-3 px-2 border-left-info">
                    <div class="contribution-content">
                        <p class="m-0 "> {{ sub }}</p>
                    </div>

                    <div class="">
                        <div>
                            <a href="{% url 'user-detail-page' sub.user %}">@{{ sub.user }}</a>
                            <span>{{ sub.date_created | date:"d/m/y h:i"}}</span>
                        </div>
                        <div class="navbar p-0 justify-content-start">
                            <a class="navbar-brand mr-1 cursor-pointer btn-contribution-vote"
                                data-contribution_id="{{ sub.id }}">
                                {% include "component/vote-icon.html" %}
                            </a>
                            <span class="mr-3">{{ sub.vote_set.all.count }}</span>
                            <span class="mr-3 btn-reply" data-toggle="collapse"
                                data-target="#sub-contribution-form-{{ contribution.id }}"
                                data-contribution_id="{{ contribution.id }}">{% include "component/reply-icon.html" %}</span>
                            <div class="dropup inline-block">
                                <span class="mr-3" data-toggle="dropdown">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-three-dots-vertical"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z">
                                        </path>
                                    </svg></span>
                                <div class="dropdown-menu dropdown-menu-right">
                                    {% if user == sub.user  %}
                                    <a class="dropdown-item cursor-pointer" data-toggle="modal"
                                        data-target="#confirm-delelte-contribution-{{sub.id}}">Delete</a>
                                    {% else %}
                                    <a class="dropdown-item cursor-not-allowed">Report</a>
                                    {% endif %}
                                </div>
                            </div>
                            {% if user == sub.user  %}
                            <!-- confirm delete contribution -->
                            <div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"
                                id="confirm-delelte-contribution-{{sub.id}}">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title">Are you sure to delete this?</h4>
                                            <button type="button" class="close" data-dismiss="modal"
                                                aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default btn-contribution-delete"
                                                data-contribution_id="{{ sub.id }}">Yes</button>
                                            <button type="button" class="btn btn-primary"
                                                data-dismiss="modal">No</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- form create sub contribution -->
                <div class="collapse collapse-contribution-form mt-3 ml-3 w-auto border-left-secondary"
                    id="sub-contribution-form-{{ contribution.id }}">
                    <form class="input-group create-new-contribution-form" data-idea_id="{{ idea.id }}"
                        data-parent_id="{{ contribution.id }}">
                        <textarea class="form-control" name="content"
                            id="textarea-contribution-{{ contribution.id }}"></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary btn-create-new-contribution"
                                type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}

            <div class="create-parent-contribution-area mt-3 pt-3 border-top">
                <div>
                    <div class="mt-3 border-left-secondary">
                        <form class="input-group create-new-contribution-form" data-idea_id="{{ idea.id }}">
                            <textarea class="form-control" name="content"></textarea>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary btn-create-new-contribution"
                                    type="submit">Send</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>


</main>


<script>
    let idea_content = `{{ idea.content | js }}`;
    let content = JSON5.parse(idea_content.slice(1, -1))

    const editor = new EditorJS({
        readOnly: true,
        holder: 'editorjs',
        minHeight: '0',
        data: content,
        tools: editor_tools
    });


    $(".create-new-contribution-form").submit(function (event) {
        event.preventDefault();
        let idea_id = $(this).data("idea_id");
        let parent_id = $(this).data("parent_id");

        let form = $(this).serializeJSON();
        create_contribution(idea_id, parent_id, form.content);
    })

    $(".btn-contribution-delete").click(function (event) {
        contribution_id = $(this).data("contribution_id");
        delete_contribution(contribution_id);
    })
    $(".btn-contribution-vote").click(function () {
        let contribution_id = $(this).data("contribution_id");
        vote_contribution(contribution_id)
    })

    $(".btn-idea-vote").click(function () {
        let idea_id = $(this).data("idea_id");
        vote_idea(idea_id)
    })

    function delete_contribution(contribution_id) {
        data = JSON.stringify({
            "contribution_id": contribution_id
        })

        $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'contribution-delete-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        }).done(function (result) {
            console.log(result)
            window.location.reload()
        })
    }


    function create_contribution(idea_id, parent_id, content) {
        data = JSON.stringify({
            "idea_id": idea_id,
            "parent_id": parent_id,
            "content": content
        })

        $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'contribution-create-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        }).done(function (result) {
            console.log(result)
            window.location.reload()
        })
    }

    function vote_idea(idea_id) {
        data = JSON.stringify({
            "idea_id": idea_id
        })

        $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'vote-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        }).done(function (result) {
            console.log(result)
            window.location.reload()
        })
    }

    function vote_contribution(contribution_id) {
        data = JSON.stringify({
            "contribution_id": contribution_id
        })

        $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'vote-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        }).done(function (result) {
            console.log(result)
            window.location.reload()
        })
    }

    $('.collapse-contribution-form').on('shown.bs.collapse', function () {
        console.log(this)
        let textarea = $(this).find("textarea");
        textarea.focus();

    })
</script>
{% endblock main-content %}