{% extends 'idea/idea-base.html' %}
{%load static %}
{% load crispy_forms_tags %}
{% load js %}
{% load voted %}



<!-- Extra head here -->
{% block extrahead %}
<title>{{ idea.title }} | whatsIdea.Business</title>
<meta name="content" content="">
{% endblock extrahead %}



<!-- Content here -->
{% block main-content %}
<style>

</style>
<main class="">
    <nav class="px-0 py-2 border-bottom mb-3 d-flex justify-content-around align-items-center">
        <h1 class="h5 m-0 flex-grow-1">{{ idea.title }}</h1>
        <div class="dropdown">
            <button type="button" class="btn" data-toggle="dropdown">
                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-three-dots-vertical" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z">
                    </path>
                </svg>
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                {% if user in idea.founder.all  %}
                <a class="dropdown-item" href="{% url 'idea-update-page' idea.slug %}">Edit</a>
                <a class="dropdown-item" href="{% url 'idea-delete-page' idea.slug %}">Delete</a>
                {% else %}
                <a class="dropdown-item cursor-not-allowed" href="">Report</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- facebook share -->
    <div class="fb-share-area mb-3">
        <div class="fb-like" data-href="{{ request.build_absolute_uri }}" data-width="" data-layout="button_count"
            data-action="like" data-size="large" data-share="true"></div>
    </div>

    {% if idea.shortdesc %}
    <div class="p-3 border-left-success">
        <p>{{ idea.shortdesc }}</p>
    </div>
    {% endif %}
    <div class="p-3 my-3 border border-left-secondary">
        <div id="editorjs"></div>
    </div>

    <!-- vote count -->
    <section class="contribution-area">
        <div class="mt-2">
            <div class="{{ idea.vote_set.all|voted:user }} btn btn-idea-vote text-decoration-none"
                data-idea_id="{{ idea.id }}">
                <span class="h4">
                    {% include "component/vote-icon.html"%}
                </span>
                <span class="vote-count">
                    {{ idea.vote_set.all.count }}
                </span>

                votes
                {% if contribution.vote_set.all.count > 1 %}
                {% endif %}
            </div>
            <button class="btn btn-contribution-and-count">
                <span class="h5" href="">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-puzzle" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M4.605 2.5V2v.5zM3.61 3.6l.498-.043V3.55l-.498.05zM7 2.5h.5A.5.5 0 0 0 7 2v.5zm-.676 1.454l.304.397-.304-.397zm3.352 0l-.304.397.304-.397zM9 2.5V2a.5.5 0 0 0-.5.5H9zm3.39 1.1l-.498-.05v.007l.498.043zM12.1 7l-.498-.043a.5.5 0 0 0 .498.543V7zm1.854-.676l.397.304-.397-.304zm0 3.352l.397-.304-.397.304zM12.1 9v-.5a.5.5 0 0 0-.498.542L12.1 9zm.29 3.4l-.498.043v.007l.498-.05zM9 13.5h-.5a.5.5 0 0 0 .5.5v-.5zm.676-1.454l-.304-.397.304.397zm-3.352 0l.304-.397-.304.397zM7 13.5v.5a.5.5 0 0 0 .5-.5H7zm-2.395 0V13v.5zm-.995-1.1l.498.05v-.007L3.61 12.4zM3.9 9l.498.042A.5.5 0 0 0 3.9 8.5V9zm-1.854.676l-.397-.304.397.304zm0-3.352l-.397.304.397-.304zM3.9 7v.5a.5.5 0 0 0 .498-.543L3.9 7zm.705-5a1.5 1.5 0 0 0-1.493 1.65l.995-.1A.5.5 0 0 1 4.605 3V2zM7 2H4.605v1H7V2zm.5.882V2.5h-1v.382h1zm-.872 1.469c.375-.287.872-.773.872-1.469h-1c0 .195-.147.42-.48.675l.608.794zM6.5 4.5l.001-.006a.113.113 0 0 1 .012-.025.459.459 0 0 1 .115-.118l-.608-.794c-.274.21-.52.528-.52.943h1zM8 5c-.491 0-.912-.1-1.19-.24a.86.86 0 0 1-.271-.194.213.213 0 0 1-.039-.063V4.5h-1c0 .568.447.947.862 1.154C6.807 5.877 7.387 6 8 6V5zm1.5-.5v.003a.213.213 0 0 1-.039.064.86.86 0 0 1-.27.193C8.91 4.9 8.49 5 8 5v1c.613 0 1.193-.123 1.638-.346.415-.207.862-.586.862-1.154h-1zm-.128-.15c.065.05.099.092.115.119.008.013.01.021.012.025L9.5 4.5h1c0-.415-.246-.733-.52-.943l-.608.794zM8.5 2.883c0 .696.497 1.182.872 1.469l.608-.794c-.333-.255-.48-.48-.48-.675h-1zm0-.382v.382h1V2.5h-1zm2.895-.5H9v1h2.395V2zm1.493 1.65A1.5 1.5 0 0 0 11.395 2v1a.5.5 0 0 1 .498.55l.995.1zm-.29 3.392l.29-3.4-.996-.085-.29 3.4.996.085zm.284-.542H12.1v1h.782v-1zm.675-.48c-.255.333-.48.48-.675.48v1c.696 0 1.182-.497 1.469-.872l-.794-.608zm.943-.52c-.415 0-.733.246-.943.52l.794.608a.459.459 0 0 1 .118-.115.113.113 0 0 1 .025-.012L14.5 6.5v-1zM16 8c0-.613-.123-1.193-.346-1.638-.207-.415-.586-.862-1.154-.862v1h.003l.01.003a.237.237 0 0 1 .053.036.86.86 0 0 1 .194.27c.14.28.24.7.24 1.191h1zm-1.5 2.5c.568 0 .947-.447 1.154-.862C15.877 9.193 16 8.613 16 8h-1c0 .491-.1.912-.24 1.19a.86.86 0 0 1-.194.271.214.214 0 0 1-.063.039H14.5v1zm-.943-.52c.21.274.528.52.943.52v-1l-.006-.001a.113.113 0 0 1-.025-.012.458.458 0 0 1-.118-.115l-.794.608zm-.675-.48c.195 0 .42.147.675.48l.794-.608c-.287-.375-.773-.872-1.469-.872v1zm-.782 0h.782v-1H12.1v1zm.788 2.858l-.29-3.4-.996.084.29 3.401.996-.085zM11.395 14a1.5 1.5 0 0 0 1.493-1.65l-.995.1a.5.5 0 0 1-.498.55v1zM9 14h2.395v-1H9v1zm.5-.5v-.382h-1v.382h1zm0-.382c0-.195.147-.42.48-.675l-.608-.794c-.375.287-.872.773-.872 1.469h1zm.48-.675c.274-.21.52-.528.52-.943h-1l-.001.006a.113.113 0 0 1-.012.025.459.459 0 0 1-.115.118l.608.794zm.52-.943c0-.568-.447-.947-.862-1.154C9.193 10.123 8.613 10 8 10v1c.492 0 .912.1 1.19.24.14.07.226.14.271.194a.214.214 0 0 1 .039.063v.003h1zM8 10c-.613 0-1.193.123-1.638.346-.415.207-.862.586-.862 1.154h1v-.003l.003-.01a.214.214 0 0 1 .036-.053.859.859 0 0 1 .27-.194C7.09 11.1 7.51 11 8 11v-1zm-2.5 1.5c0 .415.246.733.52.943l.608-.794a.459.459 0 0 1-.115-.118.113.113 0 0 1-.012-.025L6.5 11.5h-1zm.52.943c.333.255.48.48.48.675h1c0-.696-.497-1.182-.872-1.469l-.608.794zm.48.675v.382h1v-.382h-1zM4.605 14H7v-1H4.605v1zm-1.493-1.65A1.5 1.5 0 0 0 4.605 14v-1a.5.5 0 0 1-.498-.55l-.995-.1zm.29-3.393l-.29 3.401.996.085.29-3.4-.996-.086zm-.284.543H3.9v-1h-.782v1zm-.675.48c.255-.333.48-.48.675-.48v-1c-.696 0-1.182.497-1.469.872l.794.608zm-.943.52c.415 0 .733-.246.943-.52l-.794-.608a.459.459 0 0 1-.118.115.112.112 0 0 1-.025.012L1.5 9.5v1zM0 8c0 .613.123 1.193.346 1.638.207.415.586.862 1.154.862v-1h-.003a.213.213 0 0 1-.064-.039.86.86 0 0 1-.193-.27C1.1 8.91 1 8.49 1 8H0zm1.5-2.5c-.568 0-.947.447-1.154.862C.123 6.807 0 7.387 0 8h1c0-.492.1-.912.24-1.19a.86.86 0 0 1 .194-.271.213.213 0 0 1 .063-.039H1.5v-1zm.943.52c-.21-.274-.528-.52-.943-.52v1l.006.001a.112.112 0 0 1 .025.012c.027.016.068.05.118.115l.794-.608zm.675.48c-.195 0-.42-.147-.675-.48l-.794.608c.287.375.773.872 1.469.872v-1zm.782 0h-.782v1H3.9v-1zm-.788-2.858l.29 3.4.996-.085-.29-3.4-.996.085z" />
                    </svg>
                </span>
                <span>{{ idea.contribution_set.all.count }} contributions</span>
            </button>
        </div>

        <!-- contribution area -->
        <div class="contribution-area">
            <div class="contribution-list">
                {% for contribution in contributions %}
                <div class="contribution" id="parent-contribution-{{ contribution.id }}">
                    {% include "idea/component/contribution.html" with contribution=contribution %}
                    <div class="sub-sontribution-list ml-3" id="sub-sontribution-list-{{ contribution.id }}">
                        {% for sub in contribution.children.all %}
                        <div class="sub-contribution">
                            {% include "idea/component/contribution.html" with contribution=sub %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- form create sub contribution -->
                    <form method="POST" class="mt-3 collapse ml-3 create-new-contribution-form"
                        data-idea_id="{{ idea.id }}" id="sub-contribution-form-{{ contribution.id }}"
                        data-parent_id="{{ contribution.id }}">
                        <div class="text-center loading mb-3 d-none">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div class="border-left-secondary input-group">
                            <textarea class="form-control" name="content"
                                placeholder="Some contributions..."></textarea>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary btn-create-contribution"
                                    type="submit">Send</button>
                            </div>
                        </div>
                        {% if not user.is_authenticated %}
                        <p><a href="{% url 'user-login-page' %}?next={{ request.path }}">Login</a> required to make
                            contribution!</p>
                        {% endif %}
                    </form>
                </div>
                {% endfor %}
            </div>


            <!-- delete contribution -->
            <div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" id="confirm-delete-contribution">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Are you sure to delete this?</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default btn-contribution-delete">Yes</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- create contribution-->
            <form method="POST" class="mt-3 create-new-contribution-form" data-idea_id="{{ idea.id }}">
                <div class="text-center loading mb-3 d-none">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <div class="border-left-secondary input-group">
                    <textarea class="form-control" name="content" placeholder="Some contributions..."></textarea>
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary btn-create-contribution"
                            type="submit">Send</button>
                    </div>
                </div>
                {% if not user.is_authenticated %}
                <p><a href="{% url 'user-login-page' %}?next={{ request.path }}">Login</a> required to make
                    contribution!</p>
                {% endif %}
            </form>

        </div>
    </section>


</main>


<script>
    let idea_content = `{{ idea.content | js }}`;
    let content = JSON5.parse(idea_content.slice(1, -1))

    const editor = new EditorJS({
        readOnly: true,
        holder: 'editorjs',
        minHeight: '0',
        data: content,
        tools: editor_tools
    });


    // Create contribution 
    let create_contribution_form = $(".create-new-contribution-form");
    create_contribution_form.submit(function (event) {
        let collapse_form = $(this);
        collapse_form.find(".loading").removeClass('d-none');
        collapse_form.find(".btn-create-contribution").addClass("disabled")
        event.preventDefault();
        let idea_id = $(this).data("idea_id");
        let parent_id = $(this).data("parent_id");

        let form = $(this).serializeJSON();
        create_contribution(idea_id, parent_id, form.content).done(res => {
            collapse_form.find(".loading").addClass('d-none');
            collapse_form.find(".btn-create-contribution").removeClass("disabled")
            if (parent_id)
                $(`#sub-sontribution-list-${parent_id}`).append(res.contribution);
            else
                $(`.contribution-list`).append(res.contribution);

            collapse_form.find("textarea").val("");
            setTimeout(() => {
                collapse_form.collapse('hide');
            }, 200)
        });
    })



    // Confirm delete contribution modal and delete
    var confirm_delete_contribution = $('#confirm-delete-contribution')
    confirm_delete_contribution.on('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget
        // Extract info from data-contribtution-id-* attributes            
        var id = $(button).data('contribution-id')

        // Initiate an AJAX request to delete contribution
        // and update the html content 
        $(".btn-contribution-delete").click(function (event) {
            delete_contribution(id).done(res => {
                console.log(res)
                if (res.message == "contribution deleted") {
                    confirm_delete_contribution.modal('hide');
                    setTimeout(() => {
                        $(`#contribution-${id}`).remove();
                    }, 200)
                }
            })
        });



    })


    // Vote contribution
    $(document).on("click", ".btn-contribution-vote", function () {
        let btn = $(this);
        let contribution_id = btn.data("contribution_id");
        vote_contribution(contribution_id).done((res) => {
            count = parseInt($(btn).find(".vote-count").text());
            count = count ? count : 0;
            if (res.message == "vote created") {
                $(btn).addClass("btn-link");
                console.log(count++);
                $(btn).find(".vote-count").text(count);
            } else {
                $(btn).removeClass("btn-link");

                console.log(count--);
                if (count == 0) {
                    $(btn).find(".vote-count").text("");
                    return;
                }
                $(btn).find(".vote-count").text(count);
            }
        })
    })


    // Vote idea
    $(".btn-idea-vote").click(function () {
        let btn = $(this);
        let idea_id = btn.data("idea_id");
        vote_idea(idea_id).done((res) => {
            count = parseInt($(btn).find(".vote-count").text());
            count = count ? count : 0;
            if (res.message == "vote created") {
                $(btn).addClass("btn-link");
                console.log(count++);
                $(btn).find(".vote-count").text(count);
            } else {
                $(btn).removeClass("btn-link");
                console.log(count--);
                if (count == 0) {
                    $(btn).find(".vote-count").text("");
                    return;
                }
                $(btn).find(".vote-count").text(count);
            }
        });
    })

    function delete_contribution(contribution_id) {
        data = JSON.stringify({
            "contribution_id": contribution_id
        })

        return $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'contribution-delete-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        });
    }


    function create_contribution(idea_id, parent_id, content) {
        data = JSON.stringify({
            "idea_id": idea_id,
            "parent_id": parent_id,
            "content": content
        })

        return $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'contribution-create-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        })
    }

    function vote_idea(idea_id) {
        data = JSON.stringify({
            "idea_id": idea_id
        })

        return $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'vote-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        })
    }

    function vote_contribution(contribution_id) {
        data = JSON.stringify({
            "contribution_id": contribution_id
        })

        return $.ajax({
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            url: "{% url 'vote-api' %}",
            type: "POST",
            dataType: "json",
            data: data
        })
    }

    // focus when click reply
    $('.collapse-contribution-form').on('shown.bs.collapse', function () {
        let textarea = $(this).find("textarea");
        textarea.focus();
    })

    $('.btn-contribution-and-count').on('click', function () {
        let textarea = $(".create-new-contribution-form").find("textarea");
        textarea.focus();
    })

    // $('.btn-contribution-and-count').on('touchstart', function () {
    //     let textarea = $(".create-new-contribution-form").find("textarea");
    //     textarea.focus();
    // })
</script>
{% endblock main-content %}